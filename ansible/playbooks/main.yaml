---
- name: Clone Scout repository
  import_playbook: scout.yaml
  when: clone_scout_repo | default(true)

- name: Capture global air_gapped value
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Capture air_gapped state
      ansible.builtin.set_fact:
        global_air_gapped: '{{ air_gapped | default(false) }}'

- name: Deploy staging node (k3s, Traefik, Harbor)
  import_playbook: staging.yaml
  when:
    - groups.get('staging', []) | length > 0
    - hostvars['localhost']['global_air_gapped'] | default(false) | bool

- name: Install K3s
  import_playbook: k3s.yaml

- name: Configure traefik
  import_playbook: traefik.yaml

- name: Install Helm
  import_playbook: helm.yaml

- name: Install GPU Operator and Services
  import_playbook: gpu.yaml
  when: groups.get('gpu_workers', []) | length > 0

- name: Install Postgres
  import_playbook: postgres.yaml

- name: Install Redis
  import_playbook: redis.yaml

- name: Install Auth
  import_playbook: auth.yaml

- name: Install Lake
  import_playbook: lake.yaml

- name: Install Chat
  import_playbook: chatbot.yaml
  when: enable_chat | default(false) | bool

- name: Install Analytics
  import_playbook: analytics.yaml

- name: Install Orchestrator
  import_playbook: orchestrator.yaml

- name: Install Extractor
  import_playbook: extractor.yaml

- name: Install Jupyter
  import_playbook: jupyter.yaml

- name: Install Monitor
  import_playbook: monitor.yaml

- name: Install Launchpad
  import_playbook: launchpad.yaml
