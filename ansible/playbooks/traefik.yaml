---
- name: Configure Traefik
  hosts: server
  gather_facts: false
  vars:
    cert_path: '/root/{{ server_hostname }}.crt'
    key_path: '/root/{{ server_hostname }}.key'
  environment:
    KUBECONFIG: '{{ kubeconfig_yaml }}'

  tasks:
    - name: Generate self-signed certificate for CI
      become: true
      command: >
        openssl req -x509 -nodes -days 365 -newkey rsa:2048
        -keyout {{ key_path }}
        -out {{ cert_path }}
        -subj "/CN={{ server_hostname }}"
        -addext "subjectAltName=DNS:{{ server_hostname }}"
      args:
        creates: '{{ cert_path }}'
      when: lookup('env', 'CI') == 'true'

    - name: Generate TLS certificate using Tailscale
      command: 'tailscale cert --cert-file {{ cert_path }} --key-file {{ key_path }} {{ server_hostname }}'
      args:
        creates: '{{ cert_path }}'
      tags:
        - tailscale

    - name: Read TLS cert from remote
      no_log: true
      become: true
      slurp:
        src: '{{ cert_path }}'
      register: cert_file

    - name: Read TLS key from remote
      no_log: true
      become: true
      slurp:
        src: '{{ key_path }}'
      register: key_file

    - name: Create TLS secret
      no_log: true
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: tls-secret
            namespace: kube-system
          type: kubernetes.io/tls
          data:
            tls.crt: '{{ cert_file.content }}'
            tls.key: '{{ key_file.content }}'
      delegate_to: localhost

    - name: Wait for helm-install-traefik job to complete
      command: kubectl -n kube-system wait --for=condition=complete --timeout=300s job/helm-install-traefik
      register: traefik_install
      changed_when: false
      delegate_to: localhost

    - name: Wait for helm-install-traefik-crd job to complete
      command: kubectl -n kube-system wait --for=condition=complete --timeout=300s job/helm-install-traefik-crd
      register: traefik_crd_install
      changed_when: false
      delegate_to: localhost

    - name: Apply Traefik TLSStore configuration
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: traefik.io/v1alpha1
          kind: TLSStore
          metadata:
            name: default
            namespace: kube-system
          spec:
            defaultCertificate:
              secretName: tls-secret
      delegate_to: localhost

    - name: Apply Traefik configuration to enforce TLS
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: helm.cattle.io/v1
          kind: HelmChartConfig
          metadata:
            name: traefik
            namespace: kube-system
          spec:
            valuesContent: |-
              ports:
                websecure:
                  tls:
                    enabled: true
                web:
                  redirections:
                    entryPoint:
                      to: websecure
                      scheme: https
                      permanent: true
      delegate_to: localhost

    - name: Get Traefik service ClusterIP
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        name: traefik
        namespace: kube-system
      register: traefik_service
      delegate_to: localhost
      when: lookup('env', 'CI') == 'true'

    - name: Create CoreDNS custom hosts for CI
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: coredns-custom
            namespace: kube-system
          data:
            ci-hosts.server: |
              {{ server_hostname }}:53 {
                  errors
                  cache 30
                  hosts {
                      {{ traefik_service.resources[0].spec.clusterIP }} {{ server_hostname }}
                      fallthrough
                  }
              }
      delegate_to: localhost
      when: lookup('env', 'CI') == 'true'

    - name: Wait for CoreDNS to reload custom config
      ansible.builtin.pause:
        seconds: 10
      delegate_to: localhost
      when: lookup('env', 'CI') == 'true'
