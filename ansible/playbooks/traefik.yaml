---
- name: Configure Traefik
  hosts: server
  gather_facts: false
  roles:
    - scout_common
  environment:
    KUBECONFIG: '{{ kubeconfig_yaml }}'

  tasks:
    - name: Read TLS cert from remote
      no_log: true
      slurp:
        src: '{{ tls_cert_path }}'
      register: cert_file

    - name: Read TLS key from remote
      no_log: true
      slurp:
        src: '{{ tls_key_path }}'
      register: key_file

    - name: Create TLS secret
      no_log: true
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: tls-secret
            namespace: kube-system
          type: kubernetes.io/tls
          data:
            tls.crt: '{{ cert_file.content }}'
            tls.key: '{{ key_file.content }}'

    - name: Wait for helm-install-traefik job to complete
      kubernetes.core.k8s_info:
        api_version: batch/v1
        kind: Job
        name: helm-install-traefik
        namespace: kube-system
        wait: yes
        wait_condition:
          type: Complete
          status: 'True'
        wait_timeout: 300

    - name: Wait for helm-install-traefik-crd job to complete
      kubernetes.core.k8s_info:
        api_version: batch/v1
        kind: Job
        name: helm-install-traefik-crd
        namespace: kube-system
        wait: yes
        wait_condition:
          type: Complete
          status: 'True'
        wait_timeout: 300

    - name: Apply Traefik TLSStore configuration
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: traefik.io/v1alpha1
          kind: TLSStore
          metadata:
            name: default
            namespace: kube-system
          spec:
            defaultCertificate:
              secretName: tls-secret

    - name: Apply Traefik configuration to enforce TLS
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: helm.cattle.io/v1
          kind: HelmChartConfig
          metadata:
            name: traefik
            namespace: kube-system
          spec:
            valuesContent: |-
              ports:
                websecure:
                  tls:
                    enabled: true
                web:
                  redirections:
                    entryPoint:
                      to: websecure
                      scheme: https
                      permanent: true
