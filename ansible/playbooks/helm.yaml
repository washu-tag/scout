---
# Install Helm and helm-diff plugin
# Behavior depends on air_gapped variable:
# - Non-air-gapped: Install on server nodes (standard deployment)
# - Air-gapped: Install on Ansible control node (localhost)
#
# In air-gapped mode, Helm charts are deployed from localhost using
# delegate_to: localhost with remote kubeconfig access

- name: Install Helm on server nodes (non-air-gapped mode)
  hosts: server
  gather_facts: false
  tasks:
    - name: Install Helm on server node
      when: not (air_gapped | default(false) | bool)
      ansible.builtin.include_role:
        name: helm
      vars:
        helm_script_dir: /root/bin

- name: Install Helm on Ansible control node (air-gapped mode)
  hosts: localhost
  connection: local
  gather_facts: true
  tasks:
    - name: Install Helm on control node
      when: air_gapped | default(false) | bool
      ansible.builtin.include_role:
        name: helm
      vars:
        helm_script_dir: '{{ ansible_env.HOME }}/.local/bin'
