---
- name: Install launchpad
  hosts: server
  gather_facts: false
  environment:
    HELM_PLUGINS: '{{ helm_plugins_dir }}'
    KUBECONFIG: '{{ kubeconfig_yaml }}'

  tasks:
    - name: Create Traefik Middleware to strip /launchpad prefix for internal traffic
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: traefik.io/v1alpha1
          kind: Middleware
          metadata:
            name: launchpad-strip-prefix
            namespace: kube-system
          spec:
            stripPrefix:
              prefixes:
                - /launchpad

    - name: Install launchpad using Helm
      kubernetes.core.helm:
        name: launchpad
        release_namespace: '{{ launchpad_namespace }}'
        create_namespace: true
        chart_ref: '{{ scout_repo_dir }}/helm/launchpad'
        state: present
        wait: true
        wait_timeout: 5m
        atomic: true
        values_files:
          - '{{ scout_repo_dir }}/helm/launchpad/values.yaml'
        values:
          image:
            repository: '{{ launchpad_image | default(omit) }}'
          auth:
            keycloak:
              enabled: true
              clientId: '{{ keycloak_launchpad_client_id }}'
              clientSecret: '{{ keycloak_launchpad_client_secret }}'
              issuer: 'https://{{ server_hostname }}/auth/realms/scout'
            nextAuthUrl: 'https://{{ server_hostname }}//launchpad/api/auth'
            nextAuthSecret: '{{ launchpad_nextauth_secret }}'
          ingress:
            enabled: true
            className: traefik
            annotations:
              traefik.ingress.kubernetes.io/router.middlewares: >
                kube-system-launchpad-strip-prefix@kubernetescrd
            hosts:
              - host: '{{ server_hostname }}'
                paths:
                  - path: /launchpad
                    pathType: Prefix
