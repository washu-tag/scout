---
- name: Create storage directories for Dcm4chee
  hosts: k3s_cluster
  gather_facts: false
  vars_files:
    - vars/dcm4chee_storage.yaml
  tasks:
    - name: Create storage directories
      include_tasks: tasks/storage_dir_create.yaml

- name: Install Dcm4chee
  hosts: server
  gather_facts: false
  environment:
    HELM_PLUGINS: '{{ helm_plugins_dir }}'
    KUBECONFIG: '{{ kubeconfig_yaml }}'
  vars_files:
    - vars/dcm4chee_storage.yaml
  tasks:
    - name: Set up storage
      include_tasks: tasks/storage_setup.yaml

    - name: Create Dcm4chee namespace
      kubernetes.core.k8s:
        name: '{{ dcm4chee_namespace }}'
        api_version: v1
        kind: Namespace
        state: present

    - name: Create Traefik Middleware to add trailing slash
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: traefik.io/v1alpha1
          kind: Middleware
          metadata:
            name: dcm4chee-add-trailing-slash
            namespace: kube-system
          spec:
            redirectRegex:
              regex: "(.*/dcm4chee$)"
              replacement: ${1}/
              permanent: true

    - name: Create Traefik Middleware to strip prefix
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: traefik.io/v1alpha1
          kind: Middleware
          metadata:
            name: dcm4chee-strip-prefix
            namespace: kube-system
          spec:
            stripPrefix:
              prefixes:
                - /dcm4chee


