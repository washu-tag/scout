---
# Staging K3s Installation Playbook
# Installs k3s on the staging node for Harbor deployment (air-gapped mode only)
#
# Documentation: docs/source/technical/air-gapped.md

- name: Install Python kubernetes library on staging node
  hosts: staging
  roles:
    - python-kubernetes
  vars:
    # Staging node has internet access, use online installation mode
    air_gapped: false

- name: Install k3s on staging node
  hosts: staging
  vars:
    # Map staging_k3s_token to k3s_token expected by k3s role
    k3s_token: '{{ staging_k3s_token }}'
    # Staging node has internet access, use online installation mode
    air_gapped: false
  environment:
    KUBECONFIG: '{{ kubeconfig_yaml }}'
    K8S_AUTH_KUBECONFIG: '{{ kubeconfig_yaml }}'
  roles:
    # This role handles installation, service management, and verification
    # It will use online installation mode (air_gapped=false)
    # It will NOT configure registry mirrors (staging IS the registry)
    - role: k3s

  post_tasks:
    - name: Display staging k3s cluster status
      ansible.builtin.debug:
        msg: 'Staging k3s cluster is ready for Harbor deployment'
