---
# This playbook installs k3s on the staging node for Harbor deployment
# The staging node runs a separate k3s cluster from the main Scout cluster
# It must be deployed BEFORE the main k3s cluster so Harbor can cache images

- name: Shared pre-requisites for staging K3s
  hosts: staging
  vars:
    uninstall_script: '/usr/local/bin/k3s-uninstall.sh'
  tasks:
    - name: Create /root/bin directory
      ansible.builtin.file:
        path: /root/bin
        state: directory
        mode: '0700'

    - name: Download K3s installation script
      ansible.builtin.get_url:
        url: https://get.k3s.io
        dest: /root/bin/get.k3s.io.sh
        mode: '0755'

    - name: Add python kubernetes library from system package
      ansible.builtin.package:
        name: python3-kubernetes
        state: present

################################################################################
- name: Install k3s on staging node
  hosts: staging
  vars:
    # Map staging_k3s_token to k3s_token expected by k3s role
    k3s_token: '{{ staging_k3s_token }}'
    # Staging node has internet access, use online installation mode
    air_gapped: false
    # Storage directory configuration
    base_dir: '{{ base_dir | default("/var/lib/rancher/k3s/storage") }}'
    # Kubeconfig group for staging node
    kubeconfig_group: '{{ kubeconfig_group | default("root") }}'
  environment:
    KUBECONFIG: '{{ kubeconfig_yaml }}'
    K8S_AUTH_KUBECONFIG: '{{ kubeconfig_yaml }}'
  roles:
    # This role handles installation, service management, and verification
    # It will use online installation mode (air_gapped=false)
    # It will NOT configure registry mirrors (staging IS the registry)
    - role: k3s

  post_tasks:
    - name: Display staging k3s cluster status
      ansible.builtin.debug:
        msg: 'Staging k3s cluster is ready for Harbor deployment'
