---
- name: Verify cluster node state
  hosts: k3s_cluster
  gather_facts: false
  any_errors_fatal: false
  tasks:
    - name: Copy verification script
      ansible.builtin.copy:
        src: '{{ scout_repo_dir }}/verify-node/verify_node.py'
        dest: /tmp/verify_node.py
        mode: '0755'

    - name: Build verification config
      ansible.builtin.set_fact:
        _verify_config:
          hostname: '{{ inventory_hostname }}'
          mounts: '{{ verify_node_mounts | default([]) }}'
          connectivity: '{{ verify_node_connectivity | default({}) }}'
          resources: '{{ verify_node_resources | default({}) }}'

    - name: Run node verification
      ansible.builtin.command:
        cmd: >-
          python3 /tmp/verify_node.py
          {{ verify_node_command | default('all') }}
          --config-json '{{ _verify_config | to_json }}'
      register: verify_result
      changed_when: false
      failed_when: false

    - name: Show verification results
      ansible.builtin.debug:
        msg: '{{ verify_result.stdout_lines }}'

    - name: Show errors if tool failed
      ansible.builtin.debug:
        msg: '{{ verify_result.stderr_lines }}'
      when: verify_result.stderr_lines | length > 0

    - name: Fail if checks failed or errored
      ansible.builtin.fail:
        msg: "Node verification {{ 'errored (exit 2)' if verify_result.rc == 2 else 'failed (exit 1)' }}"
      when: verify_result.rc != 0

    - name: Clean up verification script
      ansible.builtin.file:
        path: /tmp/verify_node.py
        state: absent
