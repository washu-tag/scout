---
- name: Verify cluster node state
  hosts: remotes
  become: false
  gather_facts: false
  any_errors_fatal: false
  tasks:
    - name: Create secure temporary directory
      ansible.builtin.tempfile:
        state: directory
        prefix: scout_verify_
      register: _verify_tmpdir

    - name: Copy verification script
      ansible.builtin.copy:
        src: '{{ (playbook_dir ~ "/../../verify-node/verify_node.py") | realpath }}'
        dest: '{{ _verify_tmpdir.path }}/verify_node.py'
        mode: '0700'

    - name: Build verification config
      ansible.builtin.set_fact:
        _verify_config:
          hostname: '{{ inventory_hostname }}'
          mounts: '{{ verify_node_mounts | default([]) }}'
          connectivity: '{{ verify_node_connectivity | default({}) }}'
          resources: '{{ verify_node_resources | default({}) }}'

    - name: Write verification config file
      ansible.builtin.copy:
        content: '{{ _verify_config | to_json }}'
        dest: '{{ _verify_tmpdir.path }}/config.json'
        mode: '0600'

    - name: Run and report verification
      block:
        - name: Run node verification
          ansible.builtin.command:
            argv:
              - python3
              - '{{ _verify_tmpdir.path }}/verify_node.py'
              - '{{ verify_node_command | default("all") }}'
              - --config
              - '{{ _verify_tmpdir.path }}/config.json'
          register: verify_result
          changed_when: false
          failed_when: false

        - name: Show verification results
          ansible.builtin.debug:
            msg: '{{ verify_result.stdout_lines }}'
          when: verify_result.rc == 0

        - name: Fail with verification report
          ansible.builtin.fail:
            msg: |-
              {{ verify_result.stdout }}
              {% if verify_result.stderr %}

              STDERR:
              {{ verify_result.stderr }}
              {% endif %}
          when: verify_result.rc != 0

      always:
        - name: Clean up temporary directory
          ansible.builtin.file:
            path: '{{ _verify_tmpdir.path }}'
            state: absent
          diff: false
