---
- name: Deploy MailHog to Kubernetes
  hosts: server
  gather_facts: false
  vars:
    mailhog_namespace: mailhog
  tasks:
    - name: Create MailHog namespace
      kubernetes.core.k8s:
        name: '{{ mailhog_namespace }}'
        api_version: v1
        kind: Namespace
        state: present

    - name: Deploy MailHog Deployment
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: mailhog
            namespace: '{{ mailhog_namespace }}'
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: mailhog
            template:
              metadata:
                labels:
                  app: mailhog
              spec:
                containers:
                  - name: mailhog
                    image: "{{ mailhog_image | default('mailhog/mailhog:latest') }}"
                    env:
                      - name: MH_UI_WEB_PATH
                        value: /mailhog
                    ports:
                      - containerPort: 1025
                        name: smtp
                      - containerPort: 8025
                        name: http
                    resources:
                      requests:
                        memory: '64Mi'
                        cpu: '50m'
                      limits:
                        memory: '128Mi'
                        cpu: '100m'

    - name: Deploy MailHog Service
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: mailhog-service
            namespace: '{{ mailhog_namespace }}'
          spec:
            selector:
              app: mailhog
            ports:
              - name: smtp
                port: 1025
                targetPort: 1025
              - name: http
                port: 8025
                targetPort: 8025

    - name: Deploy MailHog Ingress (Traefik, no auth)
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: mailhog-ingress
            namespace: '{{ mailhog_namespace }}'
          spec:
            ingressClassName: traefik
            rules:
              - host: '{{ server_hostname }}'
                http:
                  paths:
                    - path: /mailhog
                      pathType: Prefix
                      backend:
                        service:
                          name: mailhog-service
                          port:
                            number: 8025
