---
# K3s Installation Playbook
# Installs k3s on server and agent nodes
# Supports both online and air-gapped deployment modes
#
# Documentation:
#   - Inventory configuration: docs/source/technical/inventory.md
#   - Air-gapped deployment: docs/source/technical/air-gapped.md
#   - Role details: ansible/roles/k3s/README.md

################################################################################
# Phase 1: Install Python on Staging Node (Air-gapped mode only)
################################################################################

- name: Install Python kubernetes library on staging node
  hosts: staging
  tasks:
    - name: Include python-kubernetes role
      ansible.builtin.include_role:
        name: python-kubernetes
      when: air_gapped | default(false) | bool

################################################################################
# Phase 2: Install Python on Cluster Nodes (Online mode only)
################################################################################

- name: Install Python kubernetes library on cluster nodes (online mode)
  hosts: k3s_cluster
  tasks:
    - name: Include python-kubernetes role
      ansible.builtin.include_role:
        name: python-kubernetes
      when: not (air_gapped | default(false) | bool)

################################################################################
# Phase 3: Install k3s cluster
################################################################################

- name: Install k3s cluster
  hosts: k3s_cluster
  roles:
    - scout_common
    - k3s
  environment:
    KUBECONFIG: '{{ kubeconfig_yaml }}'

################################################################################
# Phase 4: Install Python on Cluster Nodes (Air-gapped mode only)
################################################################################

- name: Install Python kubernetes library on cluster nodes (air-gapped mode)
  hosts: k3s_cluster
  tasks:
    - name: Include python-kubernetes role
      ansible.builtin.include_role:
        name: python-kubernetes
      when: air_gapped | default(false) | bool
