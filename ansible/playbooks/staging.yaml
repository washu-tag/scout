---
# Staging Node Deployment Playbook
# Installs k3s, configures Traefik, and deploys Harbor on the staging node
# Used for air-gapped deployments with Harbor registry
#
# Documentation: docs/source/technical/air-gapped.md
#
# Prerequisites:
#   - 'staging' group defined in inventory
#   - air_gapped: true in inventory

- name: Prepare staging node for K3s
  hosts: staging
  pre_tasks:
    - name: Skip if not air-gapped deployment
      ansible.builtin.meta: end_play
      when: not (air_gapped | default(false) | bool)
  tasks:
    - name: Create /root/bin directory
      ansible.builtin.file:
        path: /root/bin
        state: directory
        mode: '0700'

    - name: Download K3s installation script
      ansible.builtin.get_url:
        url: https://get.k3s.io
        dest: /root/bin/get.k3s.io.sh
        mode: '0755'

    - name: Install python kubernetes library
      ansible.builtin.package:
        name: python3-kubernetes
        state: present

- name: Deploy staging infrastructure
  hosts: staging
  pre_tasks:
    - name: Skip if not air-gapped deployment
      ansible.builtin.meta: end_play
      when: not (air_gapped | default(false) | bool)
  environment: '{{ k8s_environment }}'
  vars:
    k3s_token: '{{ staging_k3s_token }}'
    air_gapped: false # Staging node has internet access
  roles:
    - role: k3s
    - role: traefik
    - role: harbor
