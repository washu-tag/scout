---
- name: Install OAuth2 Proxy
  hosts: server
  gather_facts: false

  tasks:
    - name: Add OAuth2 Proxy Helm repository
      kubernetes.core.helm_repository:
        name: oauth2-proxy
        repo_url: https://oauth2-proxy.github.io/manifests

    - name: Create OAuth2 Proxy namespace
      kubernetes.core.k8s:
        name: '{{ oauth2_proxy_namespace }}'
        api_version: v1
        kind: Namespace
        state: present

    - name: Install OAuth2 Proxy with helm
      kubernetes.core.helm:
        name: oauth2-proxy
        chart_ref: oauth2-proxy/oauth2-proxy
        chart_version: ~7.12.0
        release_namespace: '{{ oauth2_proxy_namespace }}'
        release_state: present
        wait: true
        wait_timeout: 5m
        atomic: true
        values:
          config:
            clientID: '{{ github_client_id }}'
            clientSecret: '{{ github_client_secret }}'
            cookieSecret: '{{ oauth2_proxy_cookie_secret }}'
            configFile: |
              provider = "github"
              github_org = "{{ github_organization }}"
              reverse_proxy = true
              real_client_ip_header =  "X-Forwarded-For"
              redirect_url = "https://{{ server_hostname }}/oauth2/callback"
              skip_provider_button = true
              email_domains=  ['*']
              upstreams = [ "https://{{ server_hostname }}" ]
          ingress:
            enabled: true
            className: traefik
            path: /oauth2
            hosts:
              - '{{ server_hostname }}'

    - name: Install OAuth2 Proxy Middleware
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: traefik.io/v1alpha1
          kind: Middleware
          metadata:
            name: oauth2-proxy
            namespace: '{{ oauth2_proxy_namespace }}'
          spec:
            forwardAuth:
              address: 'https://{{ server_hostname }}/oauth2/auth'
              trustForwardHeader: true
              authResponseHeaders:
                - X-Auth-Request-Access-Token
