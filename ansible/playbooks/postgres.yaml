---
- name: Install Postgres
  hosts: server
  gather_facts: false
  environment:
    HELM_PLUGINS: '{{ helm_plugins_dir }}'
    KUBECONFIG: '{{ kubeconfig_yaml }}'
  tasks:
    - name: Add Postgres Helm repository
      kubernetes.core.helm_repository:
        name: cnpg
        repo_url: https://raw.githubusercontent.com/cloudnative-pg/charts/refs/heads/gh-pages/

    - name: Install/Upgrade Postgres Operator
      kubernetes.core.helm:
        name: cnpg
        chart_ref: cnpg/cloudnative-pg
        chart_version: ~0.23.2
        release_namespace: cnpg-system
        create_namespace: true
        release_state: present
        update_repo_cache: true
        wait: true
        wait_timeout: 5m
        atomic: true

    - name: Create namespace
      kubernetes.core.k8s:
        name: '{{ postgres_cluster_namespace }}'
        api_version: v1
        kind: Namespace
        state: present

    - name: Setup storage
      include_tasks: tasks/storage_setup.yaml
      vars:
        storage_definitions:
          - name: postgres
            size: 100Mi
            path: '{{ postgres_dir }}'

    - name: Create Postgres user secret
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: postgres-user
            namespace: '{{ postgres_cluster_namespace }}'
          type: kubernetes.io/basic-auth
          stringData:
            username: '{{ postgres_user }}'
            password: '{{ postgres_password }}'

    - name: Create Postgres superuser secret
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: superuser-secret
            namespace: '{{ postgres_cluster_namespace }}'
          type: kubernetes.io/basic-auth
          stringData:
            username: 'postgres'
            password: '{{ postgres_superuser_password }}'

    - name: Create Postgres cluster
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: postgresql.cnpg.io/v1
          kind: Cluster
          metadata:
            name: postgresql-cluster
            namespace: '{{ postgres_cluster_namespace }}'
          spec:
            instances: 1
            storage:
              storageClass: postgres-storage
              size: 100Mi
            resources:
              requests:
                cpu: 4
                memory: 16Gi
              limits:
                cpu: 6
                memory: 24Gi
            enableSuperuserAccess: true
            superuserSecret:
              name: superuser-secret
            postgresql:
              parameters:
                # Strings only, no numbers allowed
                max_connections: '100'
                shared_buffers: '4GB'
                effective_cache_size: '12GB'
                maintenance_work_mem: '2GB'
                checkpoint_completion_target: '0.9'
                wal_buffers: '16MB'
                default_statistics_target: '500'
                random_page_cost: '4'
                effective_io_concurrency: '1'
                work_mem: '20164kB'
                huge_pages: 'off'
                min_wal_size: '4GB'
                max_wal_size: '16GB'
                max_worker_processes: '4'
                max_parallel_workers_per_gather: '2'
                max_parallel_workers: '4'
                max_parallel_maintenance_workers: '2'
            bootstrap:
              initdb:
                database: '{{ ingest_postgres_table_name }}'
                owner: '{{ postgres_user }}'
                secret:
                  name: postgres-user
                postInitSQL:
                  # Create users for hive and superset databases
                  - CREATE USER {{ hive_postgres_user }} WITH PASSWORD '{{ hive_postgres_password }}';
                  - CREATE USER {{ superset_postgres_user }} WITH PASSWORD '{{ superset_postgres_password }}';
                  # Create databases
                  - CREATE DATABASE hive OWNER {{ hive_postgres_user }};
                  - CREATE DATABASE superset OWNER {{ superset_postgres_user }};

    - name: Expose metrics service for Prometheus
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: postgresql-cluster-metrics
            namespace: '{{ postgres_cluster_namespace }}'
          spec:
            selector:
              cnpg.io/cluster: postgresql-cluster
            ports:
              - name: metrics
                port: 9187
                targetPort: metrics

    - name: Wait for Postgres to be ready
      command: 'kubectl -n {{ postgres_cluster_namespace }} wait --for=condition=Ready --timeout=300s cluster/postgresql-cluster'
      register: postgres_ready
      changed_when: false
