---
# Main Harbor deployment tasks

- name: Add Harbor Helm repository
  kubernetes.core.helm_repository:
    name: harbor
    repo_url: https://helm.goharbor.io

- name: Create namespace
  ansible.builtin.include_role:
    name: scout_common
    tasks_from: namespace
  vars:
    ns: '{{ harbor_namespace }}'

- name: Set up storage
  ansible.builtin.include_role:
    name: scout_common
    tasks_from: storage_setup
  vars:
    storage_definitions: '{{ harbor_storage_definitions }}'

- name: Generate self-signed certificate
  ansible.builtin.shell: |
    openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
      -keyout /tmp/harbor-tls.key \
      -out /tmp/harbor-tls.crt \
      -subj "/CN={{ inventory_hostname }}/O=Scout Harbor"
  args:
    creates: /tmp/harbor-tls.crt

- name: Read certificate file
  ansible.builtin.slurp:
    src: /tmp/harbor-tls.crt
  register: harbor_tls_crt

- name: Read key file
  ansible.builtin.slurp:
    src: /tmp/harbor-tls.key
  register: harbor_tls_key

- name: Create TLS secret
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: '{{ harbor_tls_secret_name }}'
        namespace: '{{ harbor_namespace }}'
      type: kubernetes.io/tls
      data:
        tls.crt: '{{ harbor_tls_crt.content }}'
        tls.key: '{{ harbor_tls_key.content }}'

- name: Set Harbor expose configuration for ingress mode
  ansible.builtin.set_fact:
    harbor_expose_config:
      type: '{{ harbor_expose_type }}'
      tls:
        enabled: true
        certSource: secret
        secret:
          secretName: '{{ harbor_tls_secret_name }}'
      ingress:
        hosts:
          core: '{{ inventory_hostname }}'
        className: traefik
        annotations:
          traefik.ingress.kubernetes.io/router.entrypoints: websecure
  when: harbor_expose_type == 'ingress'

- name: Set Harbor expose configuration for nodePort mode
  ansible.builtin.set_fact:
    harbor_expose_config:
      type: '{{ harbor_expose_type }}'
      tls:
        enabled: true
        certSource: secret
        secret:
          secretName: '{{ harbor_tls_secret_name }}'
      nodePort:
        ports:
          https:
            nodePort: '{{ harbor_nodeport_https }}'
  when: harbor_expose_type == 'nodePort'

- name: Install/Upgrade Harbor
  kubernetes.core.helm:
    name: harbor
    chart_ref: harbor/harbor
    chart_version: '{{ harbor_version }}'
    release_namespace: '{{ harbor_namespace }}'
    create_namespace: true
    release_state: present
    update_repo_cache: true
    wait: true
    wait_timeout: 15m
    atomic: true
    values:
      expose: '{{ harbor_expose_config }}'
      externalURL: '{{ harbor_registry_url }}'
      harborAdminPassword: '{{ harbor_admin_password }}'
      persistence:
        persistentVolumeClaim:
          registry:
            storageClass: '{{ harbor_storage_class }}'
            size: '{{ harbor_storage_size }}'
      chartmuseum:
        enabled: false # Cannot proxy Helm charts

- name: Wait for Harbor to be ready
  ansible.builtin.uri:
    url: '{{ harbor_registry_url }}/api/v2.0/systeminfo'
    validate_certs: false
    status_code: 200
  register: harbor_health
  until: harbor_health.status == 200
  retries: 30
  delay: 10

- name: Create Docker Hub registry endpoint
  ansible.builtin.uri:
    url: '{{ harbor_registry_url }}/api/v2.0/registries'
    validate_certs: false
    method: POST
    user: admin
    password: '{{ harbor_admin_password }}'
    force_basic_auth: true
    body_format: json
    status_code: [201, 409] # 409 = already exists
    body:
      name: dockerhub
      type: docker-hub
      url: https://hub.docker.com
      insecure: false

- name: Get Docker Hub registry ID
  ansible.builtin.uri:
    url: '{{ harbor_registry_url }}/api/v2.0/registries'
    validate_certs: false
    user: admin
    password: '{{ harbor_admin_password }}'
    force_basic_auth: true
  register: registries_response

- name: Extract Docker Hub registry ID
  ansible.builtin.set_fact:
    dockerhub_registry_id: "{{ registries_response.json | selectattr('name', 'equalto', 'dockerhub') | map(attribute='id') | first }}"

- name: Create Docker Hub proxy cache project
  ansible.builtin.uri:
    url: '{{ harbor_registry_url }}/api/v2.0/projects'
    validate_certs: false
    method: POST
    user: admin
    password: '{{ harbor_admin_password }}'
    force_basic_auth: true
    body_format: json
    status_code: [201, 409]
    body:
      project_name: '{{ harbor_dockerhub_proxy_project }}'
      registry_id: '{{ dockerhub_registry_id }}'
      public: true

- name: Create GHCR registry endpoint
  ansible.builtin.uri:
    url: '{{ harbor_registry_url }}/api/v2.0/registries'
    validate_certs: false
    method: POST
    user: admin
    password: '{{ harbor_admin_password }}'
    force_basic_auth: true
    body_format: json
    status_code: [201, 409]
    body:
      name: ghcr
      type: docker-hub # GHCR uses docker registry protocol
      url: https://ghcr.io
      insecure: false

- name: Get GHCR registry ID
  ansible.builtin.uri:
    url: '{{ harbor_registry_url }}/api/v2.0/registries'
    validate_certs: false
    user: admin
    password: '{{ harbor_admin_password }}'
    force_basic_auth: true
  register: registries_response_ghcr

- name: Extract GHCR registry ID
  ansible.builtin.set_fact:
    ghcr_registry_id: "{{ registries_response_ghcr.json | selectattr('name', 'equalto', 'ghcr') | map(attribute='id') | first }}"

- name: Create GHCR proxy cache project
  ansible.builtin.uri:
    url: '{{ harbor_registry_url }}/api/v2.0/projects'
    validate_certs: false
    method: POST
    user: admin
    password: '{{ harbor_admin_password }}'
    force_basic_auth: true
    body_format: json
    status_code: [201, 409]
    body:
      project_name: '{{ harbor_ghcr_proxy_project }}'
      registry_id: '{{ ghcr_registry_id }}'
      public: true

- name: Display Harbor deployment status
  ansible.builtin.debug:
    msg: 'Harbor deployed successfully at {{ harbor_registry_url }}'
