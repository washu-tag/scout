---
- name: Verify
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../../defaults/main.yaml

  tasks:
    - name: Verify Harbor configuration variables
      ansible.builtin.assert:
        that:
          - harbor_namespace is defined
          - harbor_admin_password is defined
          - harbor_version is defined
          - harbor_registry_proxies is defined
          - harbor_registry_proxies | length > 0
        fail_msg: 'Required Harbor variables are missing'
        success_msg: '✓ All required Harbor variables are set'

    - name: Verify harbor_registry_proxies structure
      ansible.builtin.assert:
        that:
          - item.public_registry is defined
          - item.registry_name is defined
          - item.registry_type is defined
          - item.registry_url is defined
          - item.project_name is defined
        fail_msg: 'Registry proxy entry missing required fields'
        success_msg: '✓ Registry proxy entry {{ item.registry_name }} is valid'
      loop: '{{ harbor_registry_proxies }}'

    - name: Verify Harbor version format
      ansible.builtin.assert:
        that:
          - harbor_version is match('^~?\d+\.\d+\.\d+$')
        fail_msg: 'Harbor version must be in format X.Y.Z or ~X.Y.Z'
        success_msg: '✓ Harbor version format is valid'

    - name: Verify TLS secret name is defined
      ansible.builtin.assert:
        that:
          - harbor_tls_secret_name is defined
          - harbor_tls_secret_name | length > 0
        fail_msg: 'TLS secret name must be defined'
        success_msg: '✓ TLS secret name is defined'
