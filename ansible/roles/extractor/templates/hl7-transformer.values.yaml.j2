image:
  repository: '{{ hl7_transformer_image_repository }}'
  tag: '{{ hl7_transformer_image_tag }}'
envFrom:
  - secretRef:
      name: s3-secret
  - configMapRef:
      name: s3-env
  - secretRef:
      name: postgres-secret
env:
  - name: TEMPORAL_ADDRESS
    value: 'temporal-internal-frontend.{{ scout_extractor_namespace }}:7236'
  - name: TEMPORAL_NAMESPACE
    value: default
  - name: REPORT_DELTA_TABLE_NAME
    value: '{{ report_delta_table_name }}'
resources:
  requests:
    cpu: '{{ hl7_transformer_cpu_request }}'
    memory: '{{ hl7_transformer_spark_memory | jvm_memory_to_k8s }}'
  limits:
    cpu: '{{ hl7_transformer_cpu_limit }}'
    memory: '{{ hl7_transformer_spark_memory | jvm_memory_to_k8s(2) }}'
volumes:
  - name: data
{% if aws_deployment %}
    emptyDir: {}
{% else %}
    hostPath:
      path: '{{ extractor_data_dir }}'
{% endif %}
  - name: spark-defaults
    configMap:
      name: spark-defaults
  - name: modality-mapping
    configMap:
      name: modality-mapping
volumeMounts:
  - name: data
    mountPath: /data
    readOnly: true
{% if not aws_deployment %}
    mountPropagation: HostToContainer
{% endif %}
  - name: spark-defaults
    mountPath: /opt/spark/conf/spark-defaults.conf
    subPath: spark-defaults.conf
  - name: modality-mapping
    mountPath: /config/modality_mapping_codes.csv
    subPath: modality_mapping_codes.csv
    readOnly: true
ports:
  - containerPort: 8000
readinessProbe:
  httpGet:
    path: /healthz
    port: 8000
  initialDelaySeconds: 15
  periodSeconds: 10
livenessProbe:
  httpGet:
    path: /healthz
    port: 8000
  initialDelaySeconds: 30
  periodSeconds: 30
spark:
  executor:
    memory: '{{ hl7_transformer_spark_memory }}'
