---
# Kubernetes deployment tasks for Extractor services
# These tasks run on the server host (which has access to k3s_cluster inventory variables)

# - name: Initialize extractor database
#   ansible.builtin.include_role:
#     name: scout_common
#     tasks_from: create_db_with_owner
#   vars:
#     db_name: '{{ ingest_postgres_table_name }}'
#     db_owner: '{{ postgres_user }}'
#     db_owner_pass: '{{ postgres_password }}'

- name: Create namespace
  kubernetes.core.k8s:
    name: '{{ extractor_namespace }}'
    api_version: v1
    kind: Namespace
    state: present

- name: Create Postgres secret
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: postgres-secret
        namespace: '{{ extractor_namespace }}'
      type: Opaque
      stringData:
        DB_HOST: '{{ db_host }}'
        DB_PORT: '{{ db_port | string }}'
        DB_NAME: '{{ ingest_postgres_table_name }}'
        DB_USER: '{{ postgres_user }}'
        DB_PASSWORD: '{{ postgres_password }}'

- name: Create S3 secret
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: s3-secret
        namespace: '{{ extractor_namespace }}'
      type: Opaque
      stringData:
        AWS_ACCESS_KEY_ID: '{{ s3_lake_writer }}'
        AWS_SECRET_ACCESS_KEY: '{{ s3_lake_writer_secret }}'

- name: Create S3 configmap
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: s3-env
        namespace: '{{ extractor_namespace }}'
      data:
        AWS_ENDPOINT_URL: '{{ s3_endpoint }}'
        AWS_ALLOW_HTTP: 'true'
        AWS_REGION: '{{ s3_region }}'

- name: Check modality mapping file exists
  ansible.builtin.stat:
    path: '{{ modality_map_source_file }}'
  register: modality_map_stat
  delegate_to: localhost

- name: Fail with helpful message if modality map is missing
  ansible.builtin.fail:
    msg: |
      Modality mapping file not found at: {{ modality_map_source_file }}

      The default modality map should be at: {{ scout_repo_dir }}/extractor/hl7-transformer/modality_mapping_codes.csv

      If you're using a custom mapping, ensure 'modality_map_source_file' in your inventory points to a valid file path on the Ansible controller.
  when: not modality_map_stat.stat.exists

- name: Create modality mapping ConfigMap
  no_log: true
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: modality-mapping
        namespace: '{{ extractor_namespace }}'
      data:
        modality_mapping_codes.csv: '{{ lookup("file", modality_map_source_file) }}'

- name: Setup Spark defaults ConfigMap
  ansible.builtin.include_role:
    name: scout_common
    tasks_from: spark_config_setup
  vars:
    spark_defaults_configmap_name: spark-defaults
    spark_defaults_configmap_namespace: '{{ extractor_namespace }}'
    spark_memory: '{{ hl7_transformer_spark_memory }}'
    spark_hive_metastore_uri: '{{ hive_metastore_endpoint }}'
    spark_s3_username: '{{ s3_lake_writer }}'
    spark_s3_password: '{{ s3_lake_writer_secret }}'

- name: Deploy HL7Log Extractor
  ansible.builtin.include_role:
    name: scout_common
    tasks_from: deploy_helm_chart
  vars:
    helm_chart_name: hl7log-extractor
    helm_chart_ref: '{{ scout_repo_dir }}/helm/extractor/hl7log-extractor'
    helm_chart_namespace: '{{ extractor_namespace }}'
    helm_chart_create_namespace: false
    helm_chart_values: "{{ lookup('template', 'hl7log-extractor.values.yaml.j2') | from_yaml }}"

- name: Deploy HL7 Transformer
  ansible.builtin.include_role:
    name: scout_common
    tasks_from: deploy_helm_chart
  vars:
    helm_chart_name: hl7-transformer
    helm_chart_ref: '{{ scout_repo_dir }}/helm/extractor/hl7-transformer'
    helm_chart_namespace: '{{ extractor_namespace }}'
    helm_chart_create_namespace: false
    helm_chart_values: "{{ lookup('template', 'hl7-transformer.values.yaml.j2') | from_yaml }}"
