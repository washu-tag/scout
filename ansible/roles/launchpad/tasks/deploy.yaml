---
- name: Create namespace
  ansible.builtin.include_role:
    name: scout_common
    tasks_from: namespace
  vars:
    ns: '{{ launchpad_namespace }}'

- name: Create NextAuth secret for Launchpad
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: launchpad-nextauth
        namespace: '{{ launchpad_namespace }}'
      type: Opaque
      stringData:
        NEXTAUTH_SECRET: '{{ launchpad_nextauth_secret }}'
        KEYCLOAK_CLIENT_ID: '{{ keycloak_launchpad_client_id }}'
        KEYCLOAK_CLIENT_SECRET: '{{ keycloak_launchpad_client_secret }}'
        KEYCLOAK_ISSUER: 'https://keycloak.{{ server_hostname }}/realms/scout'

- name: Deploy Launchpad
  ansible.builtin.include_role:
    name: scout_common
    tasks_from: deploy_helm_chart
  vars:
    helm_chart_name: launchpad
    helm_chart_ref: '{{ launchpad_helm_chart_ref }}'
    helm_chart_namespace: '{{ launchpad_namespace }}'
    helm_chart_values_files:
      - '{{ scout_repo_dir }}/helm/launchpad/values.yaml'
    helm_chart_values:
      image:
        repository: '{{ launchpad_image_repository }}'
        tag: '{{ launchpad_image_tag }}'
      secret:
        name: launchpad-nextauth
      ingress:
        enabled: true
        className: traefik
        hosts:
          - host: '{{ server_hostname }}'
            paths:
              - path: /
                pathType: Prefix
