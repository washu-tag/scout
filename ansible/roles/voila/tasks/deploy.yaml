---
- name: Create namespace
  ansible.builtin.include_role:
    name: scout_common
    tasks_from: namespace
  vars:
    ns: '{{ voila_namespace }}'

- name: Setup Spark defaults ConfigMap
  ansible.builtin.include_role:
    name: scout_common
    tasks_from: spark_config_setup
  vars:
    spark_defaults_configmap_name: spark-defaults
    spark_defaults_configmap_namespace: '{{ voila_namespace }}'
    spark_memory: '{{ voila_spark_driver_memory }}'
    spark_hive_metastore_uri: '{{ hive_metastore_endpoint }}'
    spark_s3_username: '{{ s3_lake_writer }}'
    spark_s3_password: '{{ s3_lake_writer_secret }}'

- name: Parse Helm values
  ansible.builtin.set_fact:
    voila_helm_chart_values: "{{ lookup('template', 'values.yaml.j2') | from_yaml }}"

- name: Deploy Voil√†
  ansible.builtin.include_role:
    name: scout_common
    tasks_from: deploy_helm_chart
  vars:
    helm_chart_name: voila
    helm_chart_ref: '{{ voila_helm_chart_ref }}'
    helm_chart_namespace: '{{ voila_namespace }}'
    helm_chart_values_files:
      - '{{ scout_repo_dir }}/helm/voila/values.yaml'
    helm_chart_values: '{{ voila_helm_chart_values }}'
