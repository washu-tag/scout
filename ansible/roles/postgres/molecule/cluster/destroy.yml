---
# Destroy playbook - cleans up test resources from cluster
# Removes namespace and all resources created during testing

- name: Destroy
  hosts: localhost
  gather_facts: false
  environment:
    KUBECONFIG: '{{ kubeconfig_yaml }}'
    K8S_AUTH_KUBECONFIG: '{{ kubeconfig_yaml }}'

  tasks:
    - name: Delete test namespace
      ansible.builtin.command:
        cmd: 'kubectl delete namespace {{ postgres_cluster_namespace }} --wait=true --timeout=300s'
      register: namespace_delete
      changed_when: namespace_delete.rc == 0
      failed_when: false

    - name: Delete persistent volume (may be retained)
      ansible.builtin.command:
        cmd: 'kubectl delete pv postgres-pv'
      register: pv_delete
      changed_when: pv_delete.rc == 0
      failed_when: false

    - name: Delete storage class
      ansible.builtin.command:
        cmd: 'kubectl delete storageclass {{ postgres_storage_class }}'
      register: sc_delete
      changed_when: sc_delete.rc == 0
      failed_when: false

    - name: Remove test postgres directory
      ansible.builtin.file:
        path: '{{ postgres_dir }}'
        state: absent
