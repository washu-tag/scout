---
# Workaround for broken keycloak-config-cli Helm repository
# Reference: https://github.com/adorsys/keycloak-config-cli/issues/1287
# Uses pre-downloaded chart in air-gapped mode, direct URL in online mode

- name: Set Helm chart reference
  ansible.builtin.set_fact:
    keycloak_config_cli_chart_ref: "{{ keycloak_artifact_temp_dir + '/keycloak-config-cli.tgz' if air_gapped | default(false) | bool else 'https://adorsys.github.io/keycloak-config-cli/helm-charts/keycloak-config-cli-' + keycloak_config_cli_helm_chart_version + '.tgz' }}"

- name: Run Keycloak Config CLI to Configure Keycloak
  delegate_to: localhost
  kubernetes.core.helm:
    name: keycloak-config-cli
    release_namespace: '{{ keycloak_namespace }}'
    create_namespace: true
    chart_ref: '{{ keycloak_config_cli_chart_ref }}'
    state: present
    wait: true
    wait_timeout: 5m
    atomic: true
    values:
      image:
        repository: '{{ keycloak_config_cli_image }}'
        tag: '{{ keycloak_config_cli_image_tag }}'
      existingConfigSecret: 'keycloak-config'
      env:
        KEYCLOAK_URL: 'http://keycloak-service.{{ keycloak_namespace }}:8080/'
        KEYCLOAK_USER: '{{ keycloak_bootstrap_admin_user }}'
      existingSecret: keycloak-admin-secret
  environment:
    KUBECONFIG: '{{ local_kubeconfig_yaml | default(kubeconfig_yaml) }}'
    K8S_AUTH_KUBECONFIG: '{{ local_kubeconfig_yaml | default(kubeconfig_yaml) }}'
