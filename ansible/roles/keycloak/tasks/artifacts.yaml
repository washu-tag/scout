---
# Keycloak Artifact Preparation
# Handles both online and air-gapped modes
# Downloads CRDs, operator YAML, and Helm charts when air-gapped

- name: Prepare artifacts for air-gapped installation
  when: air_gapped | default(false) | bool
  block:
    - name: Create temporary directory for Keycloak artifacts
      ansible.builtin.tempfile:
        state: directory
        prefix: 'keycloak_airgap_'
      register: keycloak_temp_dir
      delegate_to: localhost
      run_once: true

    - name: Download Keycloak CRDs
      ansible.builtin.get_url:
        url: '{{ keycloak_crd_url }}'
        dest: '{{ keycloak_temp_dir.path }}/keycloak-crd.yml'
        timeout: '{{ keycloak_artifact_download_timeout }}'
      delegate_to: localhost
      run_once: true

    - name: Download Keycloak RealmImport CRD
      ansible.builtin.get_url:
        url: '{{ keycloak_realmimport_crd_url }}'
        dest: '{{ keycloak_temp_dir.path }}/keycloak-realmimport-crd.yml'
        timeout: '{{ keycloak_artifact_download_timeout }}'
      delegate_to: localhost
      run_once: true

    - name: Download Keycloak Operator YAML
      ansible.builtin.get_url:
        url: '{{ keycloak_operator_url }}'
        dest: '{{ keycloak_temp_dir.path }}/keycloak-operator.yml'
        timeout: '{{ keycloak_artifact_download_timeout }}'
      delegate_to: localhost
      run_once: true

    - name: Download Keycloak Config CLI Helm chart
      ansible.builtin.get_url:
        url: 'https://adorsys.github.io/keycloak-config-cli/helm-charts/keycloak-config-cli-{{ keycloak_config_cli_helm_chart_version }}.tgz'
        dest: '{{ keycloak_temp_dir.path }}/keycloak-config-cli.tgz'
        timeout: '{{ keycloak_artifact_download_timeout }}'
      delegate_to: localhost
      run_once: true

    - name: Verify all artifacts were downloaded
      ansible.builtin.stat:
        path: '{{ keycloak_temp_dir.path }}/{{ item }}'
      register: artifact_stats
      delegate_to: localhost
      run_once: true
      loop:
        - keycloak-crd.yml
        - keycloak-realmimport-crd.yml
        - keycloak-operator.yml
        - keycloak-config-cli.tgz

    - name: Fail if required artifacts are missing
      ansible.builtin.fail:
        msg: 'Required artifact missing: {{ item.item }}'
      when: not item.stat.exists
      loop: '{{ artifact_stats.results }}'
      loop_control:
        label: '{{ item.item }}'
      delegate_to: localhost
      run_once: true

    - name: Set fact with temp directory path
      ansible.builtin.set_fact:
        keycloak_artifact_temp_dir: '{{ keycloak_temp_dir.path }}'
      # NO delegate_facts, NO delegate_to - shares with all hosts

- name: Online mode artifact preparation complete
  ansible.builtin.debug:
    msg: 'Online mode: artifacts will be downloaded directly during deployment'
  when: not (air_gapped | default(false) | bool)
