---
apiVersion: batch/v1
kind: Job
metadata:
  generateName: '{{ _scout_job_name }}'
  namespace: '{{ _scout_namespace }}'
  labels:
    app: '{{ _scout_label }}'
spec:
  ttlSecondsAfterFinished: {{ _scout_ttl }}
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: '{{ _scout_label }}'
    spec:
      restartPolicy: OnFailure
      containers:
        - name: ollama-create
          image: 'ollama/ollama:{{ ollama_version | default("latest") }}'
          env:
{% if _scout_air_gapped %}
            - name: OLLAMA_MODELS
              value: '{{ ollama_nfs_mount_path }}'
{% else %}
            - name: OLLAMA_HOST
              value: 'http://{{ ollama_name }}.{{ chatbot_namespace }}:11434'
{% endif %}
          command:
            - /bin/sh
            - -c
            - |
              set -e
{% if _scout_air_gapped %}
              echo "Starting Ollama server..."
              ollama serve &
              sleep 5
{% else %}
              echo "Waiting for Ollama to be ready..."
              until ollama list > /dev/null 2>&1; do
                echo "Ollama not ready, waiting..."
                sleep 5
              done
{% endif %}

              echo "Checking if base model {{ scout_base_model }} exists..."
              if ! ollama list | grep -q "{{ scout_base_model }}"; then
                echo "Base model {{ scout_base_model }} not found. Please ensure it is pulled first."
                exit 1
              fi

              echo "Creating Scout custom model {{ scout_model_name }}..."
              cat > /tmp/Modelfile <<EOF
              FROM {{ scout_base_model }}
              PARAMETER num_predict {{ scout_model_num_predict }}
              PARAMETER num_ctx {{ scout_model_num_ctx }}
              PARAMETER num_keep {{ scout_model_num_keep }}
              EOF

              ollama create {{ scout_model_name }} -f /tmp/Modelfile

              echo "Verifying model creation..."
              if ollama list | grep -q "{{ scout_model_name }}"; then
                echo "Scout model {{ scout_model_name }} created successfully"
              else
                echo "Failed to verify Scout model creation"
                exit 1
              fi
{% if _scout_air_gapped %}
          volumeMounts:
            - name: nfs-models
              mountPath: '{{ ollama_nfs_mount_path }}'
      volumes:
        - name: nfs-models
          hostPath:
            path: '{{ ollama_nfs_path }}'
            type: DirectoryOrCreate
{% endif %}
