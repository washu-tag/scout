---
# Pull Ollama models via Kubernetes Job
# Runs in background - does not block cluster installation
#
# Modes:
#   - Online (air_gapped: false): Pull directly from registry.ollama.ai to cluster Ollama
#   - Air-gapped with NFS: Pull to shared NFS from staging, cluster mounts read-only
#
# See ADR 0008 for air-gapped architecture details

- name: Fail if air-gapped without NFS path
  ansible.builtin.fail:
    msg: >-
      Air-gapped deployment requires ollama_nfs_path to be set.
      Configure shared NFS storage for Ollama models between staging and cluster.
  when:
    - air_gapped | default(false) | bool
    - ollama_nfs_path is not defined or ollama_nfs_path | length == 0

- name: Set model pull configuration
  ansible.builtin.set_fact:
    _pull_air_gapped: '{{ air_gapped | default(false) | bool }}'
    _pull_namespace: '{{ staging_ollama_namespace if (air_gapped | default(false) | bool) else chatbot_namespace }}'
    _pull_job_name: "{{ 'ollama-download-models-' if (air_gapped | default(false) | bool) else 'ollama-pull-models-' }}"
    _pull_label: "{{ 'ollama-download-models' if (air_gapped | default(false) | bool) else 'ollama-pull-models' }}"
    _pull_ttl: '{{ 3600 if (air_gapped | default(false) | bool) else 600 }}'
    _pull_backoff: '{{ 2 if (air_gapped | default(false) | bool) else 3 }}'

- name: Create model pull Job
  kubernetes.core.k8s:
    kubeconfig: '{{ kubeconfig_yaml }}'
    state: present
    definition: '{{ lookup("template", "pull_models_job.yaml.j2") | from_yaml }}'
  delegate_to: "{{ groups['staging'][0] if _pull_air_gapped else omit }}"

- name: Model pull Job started
  ansible.builtin.debug:
    msg: >-
      Model pull Job created in {{ _pull_namespace }} namespace{{ ' on staging' if _pull_air_gapped else '' }}.
      Models will download in the background. Check status with:
      kubectl get jobs -n {{ _pull_namespace }} -l app={{ _pull_label }}
