---
- name: Add OAuth2 Proxy Helm repository
  delegate_to: localhost
  kubernetes.core.helm_repository:
    name: oauth2-proxy
    repo_url: '{{ oauth2_proxy_chart_repo }}'

- name: Create ConfigMap with OAuth2 Proxy html templates
  block:
    - name: Find all html files in oauth2-proxy templates directory
      find:
        paths: '{{ role_path }}/files'
        patterns: '*.html'
      register: oauth2_proxy_templates
      delegate_to: localhost

    - name: Create ConfigMap for OAuth2 Proxy templates
      delegate_to: localhost
      no_log: true
      kubernetes.core.k8s:
        state: present
        definition: |
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: oauth2-proxy-templates
            namespace: kube-system
          data:
            '{{ item.path | basename }}': |-
              {{ lookup("file", item.path) | indent(4) }}
      loop: '{{ oauth2_proxy_templates.files }}'
      loop_control:
        label: '{{ item.path | basename }}'

- name: Create Secret with Logo for OAuth2 Proxy
  delegate_to: localhost
  no_log: true
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: oauth2-proxy-logo
        namespace: kube-system
      type: Opaque
      data:
        logo.png: '{{ lookup("file", role_path + "/files/scout.jpg") | b64encode }}'

- name: Install OAuth2 Proxy with helm
  delegate_to: localhost
  kubernetes.core.helm:
    name: oauth2-proxy
    chart_ref: oauth2-proxy/oauth2-proxy
    chart_version: '{{ oauth2_proxy_chart_version }}'
    release_namespace: kube-system
    release_state: present
    wait: true
    wait_timeout: 3m
    atomic: true
    values:
      config:
        clientID: '{{ keycloak_oauth2_proxy_client_id }}'
        clientSecret: '{{ keycloak_oauth2_proxy_client_secret }}'
        cookieSecret: '{{ oauth2_proxy_cookie_secret }}'
        configFile: |
          provider = "keycloak-oidc"
          redirect_url = "https://auth.{{ server_hostname }}/oauth2/callback"
          oidc_issuer_url = "https://keycloak.{{ server_hostname }}/realms/scout"
          allowed_roles = "scout-user"
          cookie_expire = "{{ oauth2_proxy_cookie_expire }}"
          skip_provider_button = false
          email_domains=  ['*']
          reverse_proxy = true
          real_client_ip_header =  "X-Forwarded-For"
          custom_templates_dir = "/etc/oauth2-proxy/templates"
          custom_sign_in_logo = "/var/www/static/logo/logo.png"
          cookie_domains = [".{{ server_hostname }}"]
          whitelist_domains = [".{{ server_hostname }}"]
          backend_logout_url = "https://keycloak.{{ server_hostname }}/realms/scout/protocol/openid-connect/logout?id_token_hint={id_token}&post_logout_redirect_uri=https://{{ server_hostname }}"
          banner = "{{ oauth2_proxy_banner }}"
          footer = "{{ server_hostname }}" # Hacky way to pass server hostname to sign_in template
          upstreams = ["static://200"]
      ingress:
        enabled: true
        className: traefik
        path: /
        hosts:
          - 'auth.{{ server_hostname }}'
      extraVolumes:
        - name: oauth2-proxy-templates
          configMap:
            name: oauth2-proxy-templates
        - name: oauth2-proxy-logo
          secret:
            secretName: oauth2-proxy-logo
      extraVolumeMounts:
        - name: oauth2-proxy-templates
          mountPath: /etc/oauth2-proxy/templates
        - name: oauth2-proxy-logo
          mountPath: /var/www/static/logo

- name: Install OAuth2 Proxy Auth Middleware
  delegate_to: localhost
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: traefik.io/v1alpha1
      kind: Middleware
      metadata:
        name: oauth2-proxy-auth
        namespace: kube-system
      spec:
        forwardAuth:
          address: 'https://auth.{{ server_hostname }}/oauth2/auth'
          trustForwardHeader: true
          authResponseHeaders:
            - X-Auth-Request-Access-Token

- name: Install OAuth2 Proxy Error Middleware
  delegate_to: localhost
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: traefik.io/v1alpha1
      kind: Middleware
      metadata:
        name: oauth2-proxy-error
        namespace: kube-system
      spec:
        errors:
          status:
            - '401'
          service:
            name: oauth2-proxy
            port: 80
          query: '/oauth2/sign_in?rd={url}'
