config:
  clientID: '{{ keycloak_oauth2_proxy_client_id }}'
  clientSecret: '{{ keycloak_oauth2_proxy_client_secret }}'
  cookieSecret: '{{ oauth2_proxy_cookie_secret }}'
  configFile: |
    provider = "keycloak-oidc"
    redirect_url = "{{ oauth2_proxy_callback_url }}"
    oidc_issuer_url = "{{ keycloak_realm_url }}"
    allowed_roles = "scout-user"
    cookie_expire = "{{ oauth2_proxy_cookie_expire }}"
    skip_provider_button = false
    email_domains=  ['*']
    reverse_proxy = true
    real_client_ip_header =  "X-Forwarded-For"
    custom_templates_dir = "/etc/oauth2-proxy/templates"
    custom_sign_in_logo = "/var/www/static/logo/logo.png"
    cookie_domains = [".{{ server_hostname }}"]
    whitelist_domains = [".{{ server_hostname }}"]
    backend_logout_url = "{{ keycloak_oidc_logout_url }}?id_token_hint={id_token}&post_logout_redirect_uri=https://{{ server_hostname }}"
    banner = "{{ oauth2_proxy_banner }}"
    footer = "{{ server_hostname }}" # Hacky way to pass server hostname to sign_in template
    upstreams = ["static://200"]
    # Redis session storage - stores sessions server-side instead of in cookies
    # This prevents large cookie issues with WebSocket connections
    session_store_type = "redis"
# Store Redis connection URL with password in a Secret instead of ConfigMap
extraSecretEnv:
  - name: OAUTH2_PROXY_REDIS_CONNECTION_URL
    value: "redis://default:{{ oauth2_proxy_redis_password | urlencode }}@{{ oauth2_proxy_redis_database_name }}.{{ redis_namespace }}:{{ oauth2_proxy_redis_database_port }}"
ingress:
  enabled: true
  className: traefik
  path: /
  hosts:
    - '{{ oauth2_proxy_subdomain }}.{{ server_hostname }}'
extraVolumes:
  - name: oauth2-proxy-templates
    configMap:
      name: oauth2-proxy-templates
  - name: oauth2-proxy-logo
    secret:
      secretName: oauth2-proxy-logo
extraVolumeMounts:
  - name: oauth2-proxy-templates
    mountPath: /etc/oauth2-proxy/templates
  - name: oauth2-proxy-logo
    mountPath: /var/www/static/logo
