---
# k3s Binary Preparation
# Handles both online mode (minimal preparation) and air-gapped mode (download binaries)
# In air-gapped mode, downloads k3s binary and install script to control node, then copies to target nodes

################################################################################
# Common: Set computed paths and create bin directory
################################################################################

- name: Set k3s install script path
  ansible.builtin.set_fact:
    k3s_install_script_path: '{{ k3s_bin_dir }}/get.k3s.io.sh'

- name: Create k3s bin directory
  ansible.builtin.file:
    path: '{{ k3s_bin_dir }}'
    state: directory
    mode: '0700'

################################################################################
# Online Mode: Download install script if needed
################################################################################

- name: Check if install script already exists
  ansible.builtin.stat:
    path: '{{ k3s_install_script_path }}'
  register: k3s_install_script_stat
  when: not (air_gapped | default(false) | bool)

- name: Download K3s installation script (online mode)
  ansible.builtin.get_url:
    url: '{{ k3s_install_script_url }}'
    dest: '{{ k3s_install_script_path }}'
    mode: '0755'
  when:
    - not (air_gapped | default(false) | bool)
    - not (k3s_install_script_stat.stat.exists | default(false))

################################################################################
# Air-Gapped Mode: Download binaries to Ansible control node
################################################################################

- name: Prepare binaries for air-gapped installation
  when: air_gapped | default(false) | bool
  block:
    - name: Detect latest stable k3s version if not specified
      ansible.builtin.uri:
        url: https://update.k3s.io/v1-release/channels/stable
        follow_redirects: safe
        return_content: false
        status_code: [200, 301, 302]
      register: k3s_stable_release
      delegate_to: localhost
      run_once: true
      when: k3s_version is not defined or k3s_version == ''

    - name: Set k3s_version to latest stable if not specified
      ansible.builtin.set_fact:
        k3s_version: "{{ k3s_stable_release.url | regex_search('/tag/(.+)$', '\\1') | first }}"
      when: k3s_version is not defined or k3s_version == ''

    - name: Display k3s version being used
      ansible.builtin.debug:
        msg: 'Installing k3s version: {{ k3s_version }}'
      delegate_to: localhost
      run_once: true

    - name: Create temporary directory for k3s artifacts
      ansible.builtin.tempfile:
        state: directory
        prefix: 'k3s_airgap_'
      register: k3s_temp_dir
      delegate_to: localhost
      run_once: true

    - name: Download k3s binary
      ansible.builtin.get_url:
        url: '{{ k3s_binary_base_url }}/{{ k3s_version }}/k3s'
        dest: '{{ k3s_temp_dir.path }}/k3s'
        mode: '0755'
        timeout: '{{ k3s_artifact_download_timeout }}'
      delegate_to: localhost
      run_once: true

    - name: Download k3s install script
      ansible.builtin.get_url:
        url: '{{ k3s_install_script_url }}'
        dest: '{{ k3s_temp_dir.path }}/install-k3s.sh'
        mode: '0755'
        timeout: '{{ k3s_artifact_download_timeout }}'
      delegate_to: localhost
      run_once: true

    - name: Verify k3s binary was downloaded
      ansible.builtin.stat:
        path: '{{ k3s_temp_dir.path }}/k3s'
      register: k3s_binary_stat
      delegate_to: localhost
      run_once: true

    - name: Verify install script was downloaded
      ansible.builtin.stat:
        path: '{{ k3s_temp_dir.path }}/install-k3s.sh'
      register: k3s_install_script_stat
      delegate_to: localhost
      run_once: true

    - name: Fail if required artifacts are missing
      ansible.builtin.fail:
        msg: 'Required artifact missing: {{ item.name }}'
      when: not item.stat.stat.exists
      loop:
        - name: k3s binary
          stat: '{{ k3s_binary_stat }}'
        - name: install script
          stat: '{{ k3s_install_script_stat }}'
      delegate_to: localhost
      run_once: true

################################################################################
# Air-Gapped Mode: Copy binaries to target nodes
################################################################################

- name: Copy binaries to target nodes (air-gapped mode)
  when: air_gapped | default(false) | bool
  block:
    - name: Copy k3s binary to node
      ansible.builtin.copy:
        src: '{{ k3s_temp_dir.path }}/k3s'
        dest: '{{ k3s_binary_path }}'
        mode: '0755'

    - name: Copy k3s install script to node
      ansible.builtin.copy:
        src: '{{ k3s_temp_dir.path }}/install-k3s.sh'
        dest: '{{ k3s_install_script_path }}'
        mode: '0755'

  always:
    - name: Clean up k3s artifact temporary directory
      ansible.builtin.file:
        path: '{{ k3s_temp_dir.path }}'
        state: absent
      delegate_to: localhost
      run_once: true
      when:
        - k3s_temp_dir is defined
        - k3s_temp_dir.path is defined

################################################################################
# Online Mode: No binary preparation needed
################################################################################

- name: Online mode binary preparation complete
  ansible.builtin.debug:
    msg: 'Online mode: k3s binary and install script will be downloaded during installation by get.k3s.io script'
  when: not (air_gapped | default(false) | bool)
