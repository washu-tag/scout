---
# SELinux Package Installation for k3s
# Installs container-selinux and k3s-selinux packages when SELinux is enabled
# Only runs in air-gapped mode (online mode handles SELinux via get.k3s.io script)

- name: Display SELinux installation status
  ansible.builtin.debug:
    msg: "SELinux package installation: {{ 'ENABLED' if k3s_selinux_enabled | bool else 'DISABLED' }}"

- name: Skip SELinux installation message
  ansible.builtin.debug:
    msg: 'SELinux is not enabled, skipping SELinux package installation'
  when: not k3s_selinux_enabled | bool

- name: Install SELinux RPMs from artifacts
  ansible.builtin.include_role:
    name: scout_common
    tasks_from: install_rpms_from_artifacts
  vars:
    rpm_artifact_dir: '{{ k3s_selinux_artifact_dir }}'
    rpm_staging_dir: '{{ k3s_selinux_rpm_staging_dir }}'
    rpm_package_type: 'SELinux'
  when: k3s_selinux_enabled | bool

- name: Verify k3s SELinux policy module is loaded
  ansible.builtin.command: semodule -l
  register: semodule_list
  changed_when: false
  retries: 3
  delay: 2
  until: "'k3s' in semodule_list.stdout"
  when: k3s_selinux_enabled | bool
