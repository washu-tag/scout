---
# k3s Prerequisites
# Common setup tasks required before k3s installation
# Runs on all k3s cluster nodes (server, agents, gpu_workers)

- name: Auto-detect SELinux status if not explicitly set
  ansible.builtin.set_fact:
    k3s_selinux_enabled: "{{ ansible_selinux.status == 'enabled' if ansible_selinux is defined else false }}"
  when: k3s_selinux_enabled is not defined

- name: Set k3s install script path
  ansible.builtin.set_fact:
    k3s_install_script_path: '{{ k3s_bin_dir }}/get.k3s.io.sh'

- name: Create k3s bin directory
  ansible.builtin.file:
    path: '{{ k3s_bin_dir }}'
    state: directory
    mode: '0700'

- name: Check if install script already exists
  ansible.builtin.stat:
    path: '{{ k3s_install_script_path }}'
  register: k3s_install_script_stat
  when: not (air_gapped | default(false) | bool)

- name: Download K3s installation script (online mode)
  ansible.builtin.get_url:
    url: '{{ k3s_install_script_url }}'
    dest: '{{ k3s_install_script_path }}'
    mode: '0755'
  when:
    - not (air_gapped | default(false) | bool)
    - not (k3s_install_script_stat.stat.exists | default(false))

- name: Add python kubernetes library from system package
  ansible.builtin.package:
    name: python3-kubernetes
    state: present
