---
# Download SELinux RPMs using Kubernetes Job on staging cluster
# This task runs a Rocky Linux 9 container that uses dnf to download k3s-selinux
# and ALL its dependencies (including container-selinux, selinux-policy-base, etc.)
# with proper version resolution. All dependency RPMs are included to ensure
# air-gapped installation can succeed without external repository access.
# Only runs in air-gapped mode when SELinux is enabled

- name: Generate unique Job name and staging directory with timestamp
  ansible.builtin.set_fact:
    rpm_job_name: 'k3s-selinux-downloader-{{ ansible_date_time.epoch }}'
    rpm_staging_dir: '/tmp/k3s-selinux-rpms-{{ ansible_date_time.epoch }}'
    rpm_package_type: 'SELinux'
    rpm_download_script: |
      set -e
      set -x

      echo "Installing dnf-plugins-core for dnf download..."
      dnf install -y dnf-plugins-core

      echo "Configuring Rancher k3s repository..."
      cat > /etc/yum.repos.d/rancher-k3s-common.repo <<EOF
      [rancher-k3s-common-{{ k3s_selinux_channel }}]
      name=Rancher K3s Common ({{ k3s_selinux_channel }})
      baseurl=https://{{ k3s_selinux_rpm_site }}/k3s/{{ k3s_selinux_channel }}/common/centos/9/noarch
      enabled=1
      gpgcheck=1
      repo_gpgcheck=0
      gpgkey=https://{{ k3s_selinux_rpm_site }}/public.key
      EOF

      echo "Repository configuration:"
      cat /etc/yum.repos.d/rancher-k3s-common.repo

      echo "Downloading k3s-selinux and ALL dependencies..."
      mkdir -p /downloads
      dnf download --resolve --destdir=/downloads k3s-selinux

      echo "All downloaded packages (including dependencies):"
      ls -lh /downloads/

      rpm_count=$(ls /downloads/*.rpm 2>/dev/null | wc -l)
      echo "Package count: $rpm_count"

      if [ "$rpm_count" -eq 0 ]; then
        echo "ERROR: No RPM files were downloaded!"
        exit 1
      fi

      echo "Download completed successfully with $rpm_count packages"
  delegate_to: localhost
  run_once: true

- name: Download SELinux RPMs via Kubernetes Job
  ansible.builtin.include_tasks: download_rpms_via_job.yaml
