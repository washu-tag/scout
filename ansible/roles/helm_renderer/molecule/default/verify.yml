---
- name: Verify
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Verify helm_renderer role structure exists
      ansible.builtin.stat:
        path: '{{ item }}'
      register: role_files
      loop:
        - '{{ playbook_dir }}/../../defaults/main.yaml'
        - '{{ playbook_dir }}/../../meta/main.yaml'
        - '{{ playbook_dir }}/../../tasks/main.yaml'
        - '{{ playbook_dir }}/../../tasks/render_chart.yaml'
        - '{{ playbook_dir }}/../../tasks/apply_manifests.yaml'
        - '{{ playbook_dir }}/../../README.md'
      failed_when: >-
        not role_files.results |
        map(attribute='stat.exists') |
        select | list | length == 6

    - name: Check if Helm is installed
      ansible.builtin.command: helm version --short
      register: helm_check
      changed_when: false
      failed_when: false

    - name: Report Helm availability
      ansible.builtin.debug:
        msg: >-
          {% if helm_check.rc == 0 %}
          ✓ Helm is installed ({{ helm_check.stdout }})
          {% else %}
          ✗ Helm not installed - rendering tests were skipped
          {% endif %}

    - name: Verify role defaults include new error handling variable
      ansible.builtin.shell: |
        grep -q "helm_chart_cleanup_on_failure" {{ playbook_dir }}/../../defaults/main.yaml
      register: cleanup_var_check
      changed_when: false
      failed_when: cleanup_var_check.rc != 0

    - name: Verify apply_manifests includes error handling
      ansible.builtin.shell: |
        grep -q "Handle manifest apply failures" {{ playbook_dir }}/../../tasks/apply_manifests.yaml
      register: error_handling_check
      changed_when: false
      failed_when: error_handling_check.rc != 0

    - name: Verify documentation completeness
      ansible.builtin.shell: |
        grep -q "helm_chart_cleanup_on_failure" {{ playbook_dir }}/../../README.md
      register: doc_check
      changed_when: false
      # Don't fail if docs not yet updated - just warn
      failed_when: false

    - name: Report documentation status
      ansible.builtin.debug:
        msg: >-
          {% if doc_check.rc == 0 %}
          ✓ README documents error handling variables
          {% else %}
          ⚠ README should document helm_chart_cleanup_on_failure variable
          {% endif %}

    - name: Summary - All verifications passed
      ansible.builtin.debug:
        msg: |
          ✓ Role structure validated successfully
          ✓ Error handling implemented
          ✓ Required variables validated
          {% if helm_check.rc == 0 %}
          ✓ Rendering tests executed
          {% else %}
          ⚠ Rendering tests skipped (Helm not available)
          {% endif %}
