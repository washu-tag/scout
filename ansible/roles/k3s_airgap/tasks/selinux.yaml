---
# SELinux package installation for k3s
# Installs container-selinux and k3s-selinux packages when SELinux is enabled

- name: Display SELinux installation status
  ansible.builtin.debug:
    msg: "SELinux package installation: {{ 'ENABLED' if k3s_selinux_enabled | bool else 'DISABLED' }}"

- name: Skip SELinux installation message
  ansible.builtin.debug:
    msg: 'SELinux is not enabled, skipping SELinux package installation'
  when: not k3s_selinux_enabled | bool

- name: Install SELinux packages
  when: k3s_selinux_enabled | bool
  block:
    - name: Copy container-selinux RPM to node
      ansible.builtin.copy:
        src: '{{ k3s_artifact_temp_dir }}/container-selinux.rpm'
        dest: '{{ container_selinux_rpm_path }}'
        mode: '0644'

    - name: Copy k3s-selinux RPM to node
      ansible.builtin.copy:
        src: '{{ k3s_artifact_temp_dir }}/k3s-selinux.rpm'
        dest: '{{ k3s_selinux_rpm_path }}'
        mode: '0644'

    - name: Install container-selinux package
      ansible.builtin.yum:
        name: '{{ container_selinux_rpm_path }}'
        state: present
        disable_gpg_check: true
      register: container_selinux_install

    - name: Install k3s-selinux package
      ansible.builtin.yum:
        name: '{{ k3s_selinux_rpm_path }}'
        state: present
        disable_gpg_check: true
      register: k3s_selinux_install

    - name: Verify k3s SELinux policy module is loaded
      ansible.builtin.command: semodule -l
      register: semodule_list
      changed_when: false
      retries: 3
      delay: 2
      until: "'k3s' in semodule_list.stdout"

    - name: Clean up RPM files from node
      ansible.builtin.file:
        path: '{{ item }}'
        state: absent
      loop:
        - '{{ container_selinux_rpm_path }}'
        - '{{ k3s_selinux_rpm_path }}'
