---
# Molecule converge playbook for k3s_airgap role
# This playbook applies the role to test hosts
# Tests artifact download and logic (not actual k3s installation)

- name: Converge
  hosts: all
  gather_facts: true
  vars:
    air_gapped: true
    k3s_version: v1.33.5+k3s1
    k3s_token: test-token
    base_dir: /tmp/k3s-test
    use_staging_node: false
    k3s_selinux_enabled: false
    # Override paths to writable test locations
    k3s_binary_path: /tmp/k3s-test/k3s
    k3s_install_script_path: /tmp/k3s-test/install-k3s.sh
  tasks:
    # Create test directory
    - name: Create test directory
      ansible.builtin.file:
        path: /tmp/k3s-test
        state: directory
        mode: '0755'

    # Include the full role to test artifact download and file staging
    - name: Include k3s_airgap role
      ansible.builtin.include_role:
        name: k3s_airgap

    # Verify artifacts were staged correctly
    - name: Verify k3s binary was copied
      ansible.builtin.stat:
        path: '{{ k3s_binary_path }}'
      register: k3s_binary_stat

    - name: Verify install script was copied
      ansible.builtin.stat:
        path: '{{ k3s_install_script_path }}'
      register: k3s_install_script_stat

    - name: Assert artifacts are present and executable
      ansible.builtin.assert:
        that:
          - k3s_binary_stat.stat.exists
          - k3s_binary_stat.stat.executable
          - k3s_install_script_stat.stat.exists
          - k3s_install_script_stat.stat.executable
        fail_msg: 'Artifacts were not staged correctly'
        success_msg: 'Artifacts staged successfully'
