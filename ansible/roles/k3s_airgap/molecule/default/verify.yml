---
# Molecule verify playbook for k3s_airgap role
# This playbook verifies the role worked correctly

- name: Verify
  hosts: all
  gather_facts: true
  vars_files:
    - ../../defaults/main.yaml
  tasks:
    # Note: URL accessibility is already verified by successful downloads in converge.yml
    # No need to test URLs separately since we actually download the files

    - name: Verify temp directory pattern works
      ansible.builtin.tempfile:
        state: directory
        prefix: 'k3s_airgap_test_'
      register: test_temp_dir
      delegate_to: localhost
      run_once: true

    - name: Set test fact
      ansible.builtin.set_fact:
        test_artifact_temp_dir: '{{ test_temp_dir.path }}'

    - name: Verify fact is accessible
      ansible.builtin.assert:
        that:
          - test_artifact_temp_dir is defined
          - test_artifact_temp_dir | length > 0
        fail_msg: 'Fact sharing pattern does not work'
        success_msg: 'Fact sharing pattern works correctly'

    - name: Clean up test temp directory
      ansible.builtin.file:
        path: '{{ test_artifact_temp_dir }}'
        state: absent
      delegate_to: localhost
      run_once: true

    - name: Verify role variables are defined
      ansible.builtin.assert:
        that:
          - k3s_version is defined
          - k3s_binary_path is defined
          - k3s_install_script_path is defined
          - k3s_selinux_enabled is defined
          - k3s_artifact_download_timeout is defined
        fail_msg: 'Required role variables are missing'
        success_msg: 'All required role variables are defined'
