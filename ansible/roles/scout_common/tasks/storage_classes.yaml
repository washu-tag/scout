---
- name: Configure custom storage classes for on-premise multi-disk deployments
  when: storage_classes_to_create | length > 0
  block:
    - name: Update local-path-provisioner ConfigMap with storageClassConfigs
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: local-path-config
            namespace: local-path-storage
          data:
            config.json: |
              {
                "nodePathMap": [],
                "storageClassConfigs": {
                  {% for sc in storage_classes_to_create %}
                  "{{ sc.name }}": {
                    "nodePathMap": [
                      {
                        "node": "DEFAULT_PATH_FOR_NON_LISTED_NODES",
                        "paths": ["{{ sc.path }}"]
                      }
                    ]
                  }{{ "," if not loop.last else "" }}
                  {% endfor %}
                }
              }
            setup: |
              #!/bin/sh
              set -eu
              mkdir -m 0777 -p "$VOL_DIR"
            teardown: |
              #!/bin/sh
              set -eu
              rm -rf "$VOL_DIR"
      register: configmap_result

    - name: Note about provisioner auto-reload
      ansible.builtin.debug:
        msg: 'ConfigMap updated. local-path-provisioner will automatically reload the configuration after a brief delay.'
      when: configmap_result.changed

    - name: Create StorageClass resources
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: storage.k8s.io/v1
          kind: StorageClass
          metadata:
            name: '{{ item.name }}'
          provisioner: rancher.io/local-path
          volumeBindingMode: WaitForFirstConsumer
          reclaimPolicy: Delete
      loop: '{{ storage_classes_to_create }}'
      loop_control:
        label: '{{ item.name }}'
