---
# Create a Kubernetes ServiceAccount with IRSA annotation for AWS access
#
# Parameters:
#   sa_name: Name of the service account (e.g., 'lake-writer', 'lake-reader')
#   sa_namespace: Namespace where the service account should be created
#   sa_role_arn: AWS IAM role ARN for IRSA (e.g., '{{ lake_writer_role_arn }}')
#
# Example:
#   - include_role:
#       name: scout_common
#       tasks_from: create_service_account
#     when: aws_deployment
#     vars:
#       sa_name: lake-writer
#       sa_namespace: hive
#       sa_role_arn: '{{ lake_writer_role_arn }}'

- name: Ensure namespace {{ sa_namespace }} exists
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: '{{ sa_namespace }}'

- name: Create ServiceAccount {{ sa_name }} in namespace {{ sa_namespace }}
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: '{{ sa_name }}'
        namespace: '{{ sa_namespace }}'
        annotations:
          eks.amazonaws.com/role-arn: '{{ sa_role_arn }}'
      automountServiceAccountToken: true
