---
# Generic RPM Installation from Artifacts
# Installs RPM packages from the artifact directory to target nodes
# Used for air-gapped installation of packages that were downloaded via Kubernetes Job
#
# Required parameters:
#   - rpm_artifact_dir: Directory path on control node containing RPMs to install
#   - rpm_staging_dir: Directory path on target node where RPMs will be staged
#   - rpm_package_type: Description of package type for logging (e.g., "SELinux", "GPU")

- block:
    - name: Copy {{ rpm_package_type }} RPM archive to node
      ansible.builtin.copy:
        src: '{{ rpm_artifact_dir }}/rpms.tar.gz'
        dest: '{{ rpm_staging_dir }}/rpms.tar.gz'
        mode: '0644'

    - name: Extract {{ rpm_package_type }} RPM archive on node
      ansible.builtin.unarchive:
        src: '{{ rpm_staging_dir }}/rpms.tar.gz'
        dest: '{{ rpm_staging_dir }}/'
        remote_src: true

    - name: Find all RPM files on node
      ansible.builtin.find:
        paths: '{{ rpm_staging_dir }}'
        patterns: '*.rpm'
      register: rpm_files_on_node

    - name: Verify RPMs were extracted
      ansible.builtin.fail:
        msg: 'No RPM files found after extracting {{ rpm_package_type }} archive'
      when: rpm_files_on_node.files | length == 0

    - name: Get names of already installed packages
      ansible.builtin.shell: rpm -qa --queryformat '%{NAME}\n' | sort -u
      register: installed_package_names
      changed_when: false

    - name: Filter RPMs to exclude already installed packages
      ansible.builtin.shell: |
        for rpm_file in {{ rpm_files_on_node.files | map(attribute='path') | join(' ') }}; do
          pkg_name=$(rpm -qp --queryformat '%{NAME}' "$rpm_file" 2>/dev/null)
          if ! echo "{{ installed_package_names.stdout }}" | grep -qx "$pkg_name"; then
            echo "$rpm_file"
          fi
        done
      register: rpms_to_install
      changed_when: false

    - name: Display RPMs to be installed (excluding already installed)
      ansible.builtin.debug:
        msg: "{{ rpms_to_install.stdout_lines | map('basename') | list if rpms_to_install.stdout_lines else 'None - all packages already installed' }}"

    - name: Install {{ rpm_package_type }} packages (skipping already installed)
      ansible.builtin.dnf:
        name: '{{ rpms_to_install.stdout_lines }}'
        state: present
        disable_gpg_check: true
        disablerepo: '*'
        # Disable all repos to prevent metadata refresh in air-gapped environment
      register: rpm_install_result
      async: '{{ package_install_timeout }}'
      poll: 5
      when: rpms_to_install.stdout_lines | length > 0

  always:
    - name: Clean up staging directory
      ansible.builtin.file:
        path: '{{ rpm_staging_dir }}'
        state: absent
