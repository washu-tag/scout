---
# Generic RPM Installation from Artifacts via Local Repository
# Installs RPM packages from the artifact directory to target nodes
# Used for air-gapped installation of packages that were downloaded via Kubernetes Job
#
# Creates a temporary local dnf repo from the downloaded RPMs and installs packages
# by name, allowing dnf to resolve dependencies against the target node's actual
# package state. This avoids conflicts from unnecessary dependency upgrades.
#
# Required parameters:
#   - rpm_artifact_dir: Directory path on control node containing RPMs to install
#   - rpm_staging_dir: Directory path on target node where RPMs will be staged
#   - rpm_package_type: Description of package type for logging (e.g., "SELinux", "GPU")
#   - rpm_package_names: List of package names to install (e.g., ["k3s-selinux"])

- block:
    - name: Copy {{ rpm_package_type }} RPM archive to node
      ansible.builtin.copy:
        src: '{{ rpm_artifact_dir }}/rpms.tar.gz'
        dest: '{{ rpm_staging_dir }}/rpms.tar.gz'
        mode: '0644'

    - name: Extract {{ rpm_package_type }} RPM archive on node
      ansible.builtin.unarchive:
        src: '{{ rpm_staging_dir }}/rpms.tar.gz'
        dest: '{{ rpm_staging_dir }}/'
        remote_src: true

    - name: Verify repodata was extracted
      ansible.builtin.stat:
        path: '{{ rpm_staging_dir }}/repodata'
      register: repodata_dir

    - name: Fail if repodata not found
      ansible.builtin.fail:
        msg: 'No repodata/ found in {{ rpm_package_type }} archive. Was createrepo_c run during download?'
      when: not repodata_dir.stat.exists

    - name: Configure temporary local {{ rpm_package_type }} repository
      ansible.builtin.copy:
        content: |
          [local-{{ rpm_package_type | lower }}-rpms]
          name=Local {{ rpm_package_type }} RPM packages
          baseurl=file://{{ rpm_staging_dir }}
          enabled=1
          gpgcheck=0
        dest: '/etc/yum.repos.d/local-{{ rpm_package_type | lower }}-rpms.repo'
        mode: '0644'

    - name: Install {{ rpm_package_type }} packages from local repository
      ansible.builtin.dnf:
        name: '{{ rpm_package_names }}'
        state: present
        disablerepo: '*'
        enablerepo: 'local-{{ rpm_package_type | lower }}-rpms'
      register: rpm_install_result
      async: '{{ package_install_timeout }}'
      poll: 5

  always:
    - name: Remove temporary repository configuration
      ansible.builtin.file:
        path: '/etc/yum.repos.d/local-{{ rpm_package_type | lower }}-rpms.repo'
        state: absent

    - name: Clean up staging directory
      ansible.builtin.file:
        path: '{{ rpm_staging_dir }}'
        state: absent
