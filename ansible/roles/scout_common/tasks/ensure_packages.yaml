---
# Generic Package Installation - Online and Air-Gapped Modes
# High-level wrapper that handles package installation for both online and air-gapped environments
# Automatically creates and cleans up all temporary directories required for package staging
#
# Required parameters:
#   - package_names: List of package names to install (e.g., ["python3-kubernetes"])
#   - package_type: Description for logging (e.g., "Python", "SELinux", "GPU")
#
# Required for air-gapped mode:
#   - download_script: Bash script to download packages in Rocky Linux container
#
# Optional parameters:
#   - verify_command: Command to verify installation (optional)
#   - online_repo_setup: List of tasks for online mode repo setup (optional)

################################################################################
# Skip if packages already installed
################################################################################

- name: Check if {{ package_type }} packages are already installed
  ansible.builtin.shell: |
    rpm -q {{ package_names | join(' ') }} > /dev/null 2>&1
  register: packages_check
  changed_when: false
  failed_when: false

- name: Display package installation mode
  ansible.builtin.debug:
    msg: "{{ package_type }} packages {{ 'already installed - skipping' if packages_check.rc == 0 else 'will be installed via ' + ('downloaded RPMs (air-gapped)' if air_gapped | default(false) | bool else 'system package manager (online)') }}"

################################################################################
# Online Mode: Install directly via package manager
################################################################################

- name: Install packages (online mode)
  when:
    - not (air_gapped | default(false) | bool)
    - packages_check.rc != 0
  block:
    - name: Run online repository setup tasks
      ansible.builtin.include_tasks: '{{ online_repo_setup }}'
      when: online_repo_setup is defined

    - name: Install {{ package_type }} packages from system package manager
      ansible.builtin.package:
        name: '{{ package_names }}'
        state: present

################################################################################
# Air-Gapped Mode: Download via K8s Job, then install from RPMs
################################################################################

- name: Install packages (air-gapped mode)
  when:
    - air_gapped | default(false) | bool
  block:
    - name: Create temp directory on control node for RPM artifacts
      ansible.builtin.tempfile:
        state: directory
        prefix: '{{ package_type | lower }}_artifacts_'
      register: control_node_artifact_dir
      delegate_to: localhost
      run_once: true

    - name: Create temp directory on target nodes for RPM staging
      ansible.builtin.tempfile:
        state: directory
        prefix: '{{ package_type | lower }}_staging_'
      register: target_node_staging_dir

    - name: Set variables for download job
      ansible.builtin.set_fact:
        rpm_job_name: '{{ package_type | lower }}-downloader-{{ ansible_date_time.epoch }}'
        rpm_package_type: '{{ package_type }}'
        rpm_download_script: '{{ download_script }}'
        control_node_rpm_archive_dir: '{{ control_node_artifact_dir.path }}'
      delegate_to: localhost
      run_once: true

    - name: Download {{ package_type }} packages via Kubernetes Job
      ansible.builtin.include_tasks: download_rpms_via_job.yaml
      vars:
        rpm_artifact_dir: '{{ control_node_rpm_archive_dir }}'

    - name: Install {{ package_type }} packages from downloaded RPMs
      ansible.builtin.include_tasks: install_rpms_from_artifacts.yaml
      vars:
        rpm_staging_dir: '{{ target_node_staging_dir.path }}'
        rpm_artifact_dir: '{{ control_node_rpm_archive_dir }}'
        rpm_package_names: '{{ package_names }}'

  always:
    - name: Clean up target node staging directory
      ansible.builtin.file:
        path: '{{ target_node_staging_dir.path }}'
        state: absent
      when:
        - target_node_staging_dir is defined
        - target_node_staging_dir.path is defined

    - name: Clean up control node artifact directory
      ansible.builtin.file:
        path: '{{ control_node_artifact_dir.path }}'
        state: absent
      delegate_to: localhost
      run_once: true
      when:
        - control_node_artifact_dir is defined
        - control_node_artifact_dir.path is defined

################################################################################
# Verification (Optional)
################################################################################

- name: Verify {{ package_type }} package installation
  ansible.builtin.shell: '{{ verify_command }}'
  register: package_verify_result
  changed_when: false
  when: verify_command is defined
