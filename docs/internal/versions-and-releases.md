# Scout Versioning and Releases

This document describes Scout's versioning strategy and provides a checklist of all files that need to be updated when releasing a new version.

## Versioning Strategy

### Current Approach: Manual Updates

Scout currently uses **manual version updates**. When releasing a new version:

1. Update all version strings in the files listed below
2. Commit the changes
3. Tag the commit (optional)
4. CI publishes images with the version tag

### Day-to-Day Development

For day-to-day development on `main`, Scout component versions are set to development values. CI publishes any changes to `main` with the `latest` Docker image tag, allowing continuous integration without version string changes.

**Development version values:**
- Most components: `latest`
- Python packages: `0.0.dev0` (required by PEP-440; see note below)

**Note on Python versions**: Python package versions must comply with [PEP-440](https://peps.python.org/pep-0440/), which does not allow `latest` as a version string. We use `0.0.dev0` for the Python package version, but create a separate `VERSION` file containing `latest` which CI uses for Docker image tagging (VERSION file takes precedence over pyproject.toml).

### Release Process

When it's time to release a new version (e.g., `2.1.0`):

1. Create a release branch or work directly on `main`
2. Update all version strings to the new version (see checklist below)
3. Commit with message: "Update to version X.Y.Z"
4. Create a git tag: `git tag vX.Y.Z`
5. Push the commit and tag
6. CI builds and publishes images with the version tag
7. Reset versions back to development values (`latest` / `0.0.dev0`)
8. Commit with message: "Reset versions to development"

### Future Consideration: Tag-Triggered Releases

A potential improvement would be to automate version tagging through CI:
- Continue development with `latest` versions
- When ready to release, tag a commit (e.g., `v2.1.0`)
- CI detects the tag and builds/publishes all images with that version
- This would eliminate the need to manually update version strings for releases

## Version Update Checklist

When releasing a new Scout version, update all files in this checklist.

### Ansible Role Defaults (Docker Image Tags)

These control which image tags are deployed by Ansible:

| File | Variable |
|------|----------|
| `ansible/roles/scout_common/defaults/main.yaml` | `jupyter_singleuser_image_tag` |
| `ansible/roles/extractor/defaults/main.yaml` | `hl7log_extractor_image_tag` |
| `ansible/roles/extractor/defaults/main.yaml` | `hl7_transformer_image_tag` |
| `ansible/roles/launchpad/defaults/main.yaml` | `launchpad_image_tag` |

### Python Package

| File | Field | Dev Value | Release Value |
|------|-------|-----------|---------------|
| `extractor/hl7-transformer/pyproject.toml` | `version` | `0.0.dev0` | `X.Y.Z` |
| `extractor/hl7-transformer/VERSION` | entire file | `latest` | `X.Y.Z` |

**Note**: The VERSION file controls the Docker image tag (CI checks it first). The pyproject.toml version is for the Python package metadata and must be PEP-440 compliant.

### Java/Gradle Build Files

| File | Field |
|------|-------|
| `extractor/hl7log-extractor/build.gradle` | `version` |
| `keycloak/event-listener/build.gradle` | `version` |
| `tests/build.gradle` | `version` |

### npm Packages

| File | Field |
|------|-------|
| `launchpad/package.json` | `version` |

After updating `package.json`, run `npm install` in the `launchpad/` directory to regenerate `package-lock.json`:

```bash
cd launchpad && npm install
```

**Important**: Do NOT manually edit `package-lock.json`. This file is auto-generated by npm and contains version information for all external dependencies. Manual edits can corrupt dependency resolution.

### Helm Charts

**Scout Application Charts** (update both `version` and `appVersion`):

| File | Fields |
|------|--------|
| `helm/launchpad/Chart.yaml` | `version`, `appVersion` |
| `helm/launchpad/values.yaml` | `image.tag` |
| `helm/extractor/hl7-transformer/Chart.yaml` | `version`, `appVersion` |
| `helm/extractor/hl7log-extractor/Chart.yaml` | `version`, `appVersion` |

**Charts for External Applications** (update only `version`, NOT `appVersion`):

| File | Field | Note |
|------|-------|------|
| `helm/hive-metastore/Chart.yaml` | `version` only | `appVersion` tracks Hive version |
| `helm/voila/Chart.yaml` | `version` only | `appVersion` tracks Voila version |
| `helm/voila/values.yaml` | `image.tag` | Uses pyspark-notebook image |

### VERSION Files

These plain-text files control Docker image tags (CI checks VERSION files first):

| File | Dev Value | Release Value |
|------|-----------|---------------|
| `extractor/hl7-transformer/VERSION` | `latest` | `X.Y.Z` |
| `helm/jupyter/notebook/VERSION` | `latest` | `X.Y.Z` |

## Files NOT to Update

These files track external dependency versions and should NOT be manually updated:

| File | Purpose |
|------|---------|
| `launchpad/package-lock.json` | Auto-generated by npm; regenerate with `npm install` |
| `ansible/group_vars/all/versions.yaml` | External dependency versions (Helm charts, operators, etc.) |
| `helm/superset/VERSION` | Apache Superset application version |
| `keycloak/VERSION` | Keycloak application version |
| `helm/dcm4chee/Chart.yaml` | Optional external component (maintains own version) |
| `helm/orthanc/Chart.yaml` | Optional external component (maintains own version) |

## Quick Reference: Version Formats

**For releases** (version `X.Y.Z`):
- YAML files: `X.Y.Z` or `"X.Y.Z"` (quoted for `appVersion`)
- JSON files: `"X.Y.Z"`
- TOML files: `"X.Y.Z"`
- Gradle files: `'X.Y.Z'`
- VERSION files: `X.Y.Z` (plain text, single line)

**For development** (after release, reset to):
- Most files: `latest`
- Python pyproject.toml: `"0.0.dev0"` (PEP-440 compliant)

## CI Version Detection

The GitHub Actions workflow uses `.github/actions/derive-version/action.yaml` to detect versions from source files. The priority order is:

1. `VERSION` file (if present)
2. `package.json` version field
3. `build.gradle` version field
4. `pyproject.toml` version field

This allows CI to automatically detect and use the correct version for building and publishing images.
